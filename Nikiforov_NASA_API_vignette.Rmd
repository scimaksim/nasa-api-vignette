---
title: "NASA API Vignette"
always_allow_html: true
output: 
  github_document:
    toc: true
    toc_depth: 3
# Bibliography and citation tips provided by 
# https://bookdown.org/yihui/rmarkdown-cookbook/bibliography.html
bibliography: references.bib 
csl: apa.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(httr)
library(jsonlite)
library(DT)
library(latex2exp)
```

## Package requirements

To re-create this vignette in R, users are required to install 

* **[tidyverse](https://www.tidyverse.org/)** - encompasses packages such as `dplyr` for subsetting data and `ggplot2` for creating layered graphics.  
* **[httr](https://httr.r-lib.org/)** - supplies the `GET()` function to programmatically retrieve content from NASA Exoplanet Archive's [TAP service](https://exoplanetarchive.ipac.caltech.edu/docs/TAP/usingTAP.html#examples). 
* **[jsonlite](https://cran.r-project.org/web/packages/jsonlite/vignettes/json-aaquickstart.html)** - supplies the `fromJSON()` function to simplify JSON content into an atomic vector.
* **[DT](https://rstudio.github.io/DT/)** - suplies the `datatables()` function with "filtering, pagination, sorting, and many other features" in the tables". 
* **[latex2exp](https://cran.r-project.org/web/packages/latex2exp/vignettes/using-latex2exp.html)** - "an R package that parses and converts LaTeX math formulas to Râ€™s plotmath expressions". This is useful for labeling masses and radii on plots using [solar system symbols](https://solarsystem.nasa.gov/resources/680/solar-system-symbols/).   

## Custom functions

### annualExoDiscoveries()

This custom function programmatically retrieves data from the [NASA Exoplanet Archive's TAP service](https://exoplanetarchive.ipac.caltech.edu/docs/TAP/usingTAP.html#examples). Users can specify one of two tables - Planetary Systems (**ps**) or Planetary Systems Composite Parameters (**pscomppars**) - as well as a range for the year(s) in which planets were discovered. The default values for this function are:

* `tableName = "pscomppars"` - according to the [table definitions](https://exoplanetarchive.ipac.caltech.edu/docs/API_PS_columns.html) for **ps** and **pscomppars**, "PSCompPars is a more filled-in table, with only one row per planet, enabling a more statistical view of the known exoplanet population and their host environments. This table provides a more complete, though not necessarily self-consistent, set of parameters".
* `startYear = 1989` - the earliest listing in the PSCompPars table, attributed to the planet [HD 114762 b](https://exoplanetarchive.ipac.caltech.edu/overview/HD%20114762%20b#planet_data_HD-114762-b).  
* `endYear = as.integer(format(Sys.Date(), "%Y"))` - the current calendar year as understood by the user's computer. 
* `controversial = 0` - exclude planets for which the confirmation status "has been questioned in the published literature". 

```{r , echo=TRUE, eval=TRUE}
# Retrieve exoplanet names, discovery year, and discovery method.
# Defaults start in the year 1989 (earliest year in the pscomppars table)
# and end in the current calendar year: format(Sys.Date(), "%Y").

annualExoDiscoveries <- function(tableName = "pscomppars", startYear = 1989, endYear = as.integer(format(Sys.Date(), "%Y")), controversialFlag = 0){
  # Create URL string
  urlString <- paste0("https://exoplanetarchive.ipac.caltech.edu/TAP/sync?query=select+pl_name,disc_year,discoverymethod,pl_orbper,pl_rade,pl_bmasse,pl_radj,pl_bmassj,pl_eqt,st_spectype,st_teff,st_lum,pl_controv_flag,pl_orbeccen,pl_orbsmax,st_mass,st_metratio,st_met+from+", tableName, "+where+disc_year+between+", startYear, "+and+", endYear, "+and+pl_controv_flag+=+", controversialFlag, "&format=json")
  # Provide string to httr GET function
  apiCall <- GET(urlString)
  # Convert JSON content to data frame, rename columns
  apiContent <- apiCall$content %>% rawToChar() %>% fromJSON() %>%
    mutate(luminosityRatio = 10^(st_lum)) 
  
  # Return formatted data frame
  return(apiContent)
}
```

### calculateHZ

This function calculates exoplanetary habitable zones and their associated stellar flux boundaries for a star of effective temperature `tempEff` and a stellar luminosity `luminosityRatio`. The calculations are based on formulae defined by Kopparapu et al., whereby the effective solar flux $S_{eff}$ is defined as $S_{eff} = S_{eff \odot} + aT_{\star} + bT_{\star}^2+ cT_{\star}^3 + dT_{\star}^4$ and the corresponding habiatability zone distances, $d$, are defined as $d = (\frac{L/L \odot}{S_{eff}})^{0.5}$ AU [@Kopparapu_2014]. The required parameters for this function are:

* `tempEff` - the effective temperature of a star. $T_{eff}$ is defined as the difference between `tempEff` ($T_{eff}$) and 5780 K, $T_{\star} = T_{eff} - 5780$. 
* `luminosityRatio` - stellar luminosity, defined as the ratio $\frac{L}{L \odot}$. These values are calculated in the `annualExoDiscoveries` function by finding the inverse logarithm of `st_lum` (the stellar luminosity in the **PSCompPars** table, provided in units of $log(Solar)$). The values in this vector are used to calculate the habiatability zone distances, $d$.

The output of this function is a list with four numeric parameters - _optimisticInnerDist_, _optimisticOuterDist_, _optimisticInnerFlux_, and _optimisticOuterFlux_ - which are used in the function `hzFluxCalculator()`.

```{r , echo=TRUE, eval=TRUE}
# Calculate habitable stellar flux boundaries for exoplanetary habitable zones. 
# Distances returned in Astronomical Units (AU).
# Formula and it coefficients provided by Kopparapu et al.
# https://iopscience.iop.org/article/10.1088/2041-8205/787/2/L29
# Re-factored to R from John Armstrong's Python code at
# https://depts.washington.edu/naivpl/sites/default/files/hzcalc.py.txt

calculateHZ <- function(tempEff, luminosityRatio){
  
  # Initiate vectors
  s_eff <- vector()
  distanceFromStar <- vector()
  
  starTemp <- vector()
  recentVenus <- vector()
  runawayGreenhouse <- vector()
  maxGreenhouse <- vector()
  earlyMars <- vector()
  fivemeRunaway <- vector()
  tenthmeRunaway <- vector()
  
  s_eff_sun  = c(1.776, 1.107, 0.356, 0.320, 1.188, 0.99)
  a <- c(2.136e-4, 1.332e-4, 6.171e-5, 5.547e-5, 1.433e-4, 1.209e-4)
  b <- c(2.533e-8, 1.580e-8, 1.698e-9, 1.526e-9, 1.707e-8, 1.404e-8)
  c <- c(-1.332e-11, -8.308e-12, -3.198e-12, -2.874e-12, -8.968e-12, -7.418e-12)
  d <- c(-3.097e-15, -1.931e-15, -5.575e-16, -5.011e-16, -2.084e-15, -1.713e-15)
  
  t_star <- tempEff-5780
  
  for (i in 1:length(a)){
    s_eff[i] <- s_eff_sun[i] + a[i]*t_star + b[i]*t_star^2 + c[i]*t_star^3 + d[i]*t_star^4
    distanceFromStar[i] <- (luminosityRatio/s_eff[i])^0.5
    
    optimisticInnerDist <- distanceFromStar[1]
    optimisticOuterDist <- distanceFromStar[4]
    
  }
  
  optimisticInnerDist <- distanceFromStar[1]
  optimisticOuterDist <- distanceFromStar[4]
  
  optimisticInnerFlux <- s_eff[1]
  optimisticOuterFlux <- s_eff[4]
  
  return(list(optimisticInnerDist = optimisticInnerDist, optimisticOuterDist = optimisticOuterDist, 
              optimisticInnerFlux = optimisticInnerFlux, optimisticOuterFlux = optimisticOuterFlux))
}

testVals <- annualExoDiscoveries()
funcTest <- calculateHZ(5780, 1.5)
str(funcTest)
```

### hzFluxCalculator()

This custom function calculates the minima and the maxima for a planet's habitability zone (in units of _AU_) and stellar flux (in units of _dex_). It requires the name of a data set and operates with the following default parameters:

* `earthMassCol = "pl_bmasse"` - a vector with planetary masses in units of Earth mass ($M \oplus$).
* `starSpecTypeCol = "st_spectype"` - a vector listing the spectral type of host stars.
* `effectiveTempCol = "st_teff"` - a vector listing the effective temperatures of host stars.
* `luminosityRatioCol = "luminosityRatio"` - a vector with the stellar luminosity ratios, $\frac{L}{L \odot}$. 

These default column names are based on the variables in the [Planetary Systems Composite Parameters (PSCompPars)](https://exoplanetarchive.ipac.caltech.edu/docs/API_PS_columns.html) table. `luminosityRatioCol` is calculated and appended to each data frame that stems from the `annualExoDiscoveries()` function. 

```{r , echo=TRUE, eval=TRUE}
# Customer function to calculate values for 
# inner and outer habitable zone, flux
hzFluxCalculator <- function(data, earthMassCol = "pl_bmasse", 
                             starSpecTypeCol = "st_spectype", 
                             effectiveTempCol = "st_teff",
                             luminosityRatioCol = "luminosityRatio"){
  
  data %>% mutate(innerHZ = NA, outerHZ = NA, innerFlux = NA, outerFlux = NA,
                  spectralClass = NA)
  
  earthMassCol <- data[ , earthMassCol]
  starSpecTypeCol <- data[ , starSpecTypeCol]
  effectiveTempCol <- data[ , effectiveTempCol]
  luminosityRatioCol <- data[ , luminosityRatioCol]
  
  for(i in 1:length(earthMassCol)){
    if(!is.na(starSpecTypeCol[i])){
      data$spectralClass[i] <- substr(starSpecTypeCol[i], 1, 1)
    } else {
      data$spectralClass[i] <- NA
    }
    
    
    if(!is.na(earthMassCol[i]) & earthMassCol[i] <= 10 & 
       earthMassCol[i] >= 0.1){
      
      
      hzVars <- calculateHZ(effectiveTempCol[i], 
                            luminosityRatioCol[i])
      
      data$innerHZ[i] <- hzVars[[1]]
      data$outerHZ[i] <- hzVars[[2]]
      
      data$innerFlux[i] <- hzVars[[3]]
      data$outerFlux[i] <- hzVars[[4]]
      
    } else {
      data$innerHZ[i] <- NA
      data$outerHZ[i] <- NA
      data$innerFlux[i] <- NA
      data$outerFlux[i] <- NA
    }
  }
  
  return(data)
}
```

### habitableExoFinder()

This function produces a data frame of potentially habitable exoplanets based on a set of parameters. The default parameters are:

* `minEarthMass = 0.1` - 
* `maxEarthMass = 5` - 
* `minEarthRadius = 0.5` - 
* `maxEarthRadius = 1.5` - 
* `maxInnerFlux = 1.5` - 
* `maxOuterFlux = 0.20` - 
* `minTemp = 273` - 
* `maxTemp = 340` - 


```{r , echo=TRUE, eval=TRUE}
# Create function to identify potentially habitable exoplanets. 
# Default function parameters provided by Planetary Habitability Laboratory, 
# http://phl.upr.edu/projects/habitable-exoplanets-catalog
habitableExoFinder <- function(data, minEarthMass = 0.1, maxEarthMass = 5, 
                               minEarthRadius = 0.5, maxEarthRadius = 1.5,
                               maxInnerFlux = 1.5, maxOuterFlux = 0.20,
                               minTemp = 273, maxTemp = 340){
  
  # Subset data using provided parameters
  habitablePlanets <- data %>% select(pl_name, pl_eqt, spectralClass, pl_bmasse, pl_rade, 
                                      pl_orbeccen, pl_orbsmax, innerHZ, outerHZ, innerFlux, outerFlux) %>% 
    filter(spectralClass %in% c("F", "G", "K", "M") & (pl_orbsmax >= innerHZ) & (pl_orbsmax <= outerHZ) & (pl_bmasse >= minEarthMass) &
             (pl_bmasse <= maxEarthMass) & (pl_rade >= minEarthRadius) & (pl_rade <= maxEarthRadius) &
             (innerFlux <= maxInnerFlux) & (outerFlux >= maxOuterFlux) &
             (pl_eqt <= maxTemp | (is.na(pl_eqt))) & (pl_eqt >= minTemp | (is.na(pl_eqt == NA))))
  
  return(habitablePlanets)
}
```


## Exploratory Data Analysis

```{r , echo=TRUE, eval=TRUE}
# Retrieve latest exoplanet data
exoplanetCount <- annualExoDiscoveries()

# Display in a searchable table using DT library's datatable function
head(exoplanetCount)
```

As of `r date()`, the NASA Exoplanet Archive's [Planetary Systems Composite Parameters](https://exoplanetarchive.ipac.caltech.edu/docs/API_PS_columns.html) (PSCompPars) table lists `r length(exoplanetCount$pl_name)` confirmed and unconfirmed exoplanet observations. The stacked bar plot below enumerates the annual number of exoplanet findings since 1989 and highlights 2014 and 2016 as the most prolific years for discovery.  

```{r , echo=TRUE, eval=TRUE}
# Retrieve latest exoplanet data
exoData <- annualExoDiscoveries() 

# Create horizontal bar plot with annual number of discoveries
annualDiscoveries <- ggplot(exoData, aes(x = as.character(disc_year)))
annualDiscoveries + geom_bar(aes(fill = discoverymethod), 
                             alpha = 0.8, position = "stack") +
  labs(x = "Discovery year", y = "Count",
       title = "Exoplanet discoveries over time", 
       subtitle = "Grouped by discovery method") +
  scale_fill_discrete(name = "Discovery method") +
  theme(axis.text.x = element_text(angle = 45)) + 
  geom_text(stat="count", aes(label=..count..), 
            vjust=0.5, hjust = -0.01, size = 2.2) +
  coord_flip() 
```

```{r , echo=TRUE, eval=TRUE}
# Contingency table, total number of exoplanets found with each discovery method
discoveriesByMethod <- table(exoData$discoverymethod)
discoveriesByMethod
```

Of the known `r length(exoplanetCount$pl_name)` exoplanets, `r round((discoveriesByMethod[10])/(length(exoplanetCount$pl_name))*100, 1)`% were observed transiting their host star. Another `r round((discoveriesByMethod[9])/(length(exoplanetCount$pl_name))*100, 1)`% were observed indirectly via the radial velocity method, whereby the planet and its star orbit around a common center of gravity and prompt noticeable Doppler shifts in the stellar spectrum. The contingency table below summarizes the cumulative number of observations for the remaining discovery methods.  


```{r , echo=TRUE, eval=TRUE}
summary(exoData$pl_bmasse)
summary(exoData$pl_rade)
summary(exoData$pl_orbeccen)
```

```{r , echo=TRUE, eval=TRUE}
# Masses, radii, eccentricities, and orbit semi-major axes
densityOrbtialProp <- annualExoDiscoveries() 
densityOrbtialProp <- densityOrbtialProp %>% select(pl_orbeccen, pl_orbsmax) %>% 
  filter(!is.na(pl_orbeccen) & !is.na(pl_orbsmax))


orbEccenCDF <- ggplot(densityOrbtialProp, aes(x = pl_orbeccen))
orbEccenCDF + stat_ecdf(geom = "step")


# Scatter plot of masses/radii for discovered exoplanets
# Use LaTeX to denote the standard astronomical symbol for the Earth
orbsEccenScatter <- ggplot(densityOrbtialProp, aes(x = pl_orbsmax, y = pl_orbeccen, scale_x_log10()))
orbsEccenScatter + geom_point(alpha = 0.6, position = "jitter") +
  scale_x_log10() +
  labs(x = TeX(r'(Mass $(log(M\oplus))]$))'), y = TeX(r'(Radius $(R\oplus)$)'),
       title = "Comparison of radius and logarithmic mass amongst known exoplanets")
```


```{r , echo=TRUE, eval=TRUE}
metallicityData <- annualExoDiscoveries() 
metallicityData <- metallicityData %>% select(st_metratio, st_met, discoverymethod, pl_bmassj, pl_bmasse, pl_orbper) %>% 
  filter(st_metratio == "[Fe/H]" & 
           (discoverymethod %in% c("Transit", "Radial Velocity", "Microlensing")))

metallicityHisto <- ggplot(metallicityData, aes(x = st_met))
metallicityHisto + geom_histogram(aes(fill = metallicityData$discoverymethod), adjust = 0.5, alpha = 0.5) +
  labs(x = "Stellar metallicity [Fe/H]", y = "Count",
       title = "The distribution of exo planets as a function of stellar metallicity",
       subtitle = "Grouped by discovery method") 
```

The Planetary Habitability Laboratory outlines its [general habitability criteria](http://phl.upr.edu/projects/habitable-exoplanets-catalog/methods) as follows:

1. The planet orbits an F, G, K, or M star.
2. The planet orbits within the optimistic (aka empirical) habitable zone defined by Kopparapu et al. (2014) and corrected for eccentric orbits by MÃ©ndez & Rivera-ValentÃ­n (2017).
3. The planet has a radius between 0.5 to 2.5 Earth radii or a minimum mass between 0.1 to 10 Earth masses.

We can calculate the maxima and minima for habitable zones and flux using formulae provided by Kopparapu et al. [@Kopparapu_2014]. 

```{r , echo=TRUE, eval=TRUE}
# Grab up-to-date data from API
planetData <- annualExoDiscoveries()

# Calculate maxima/minima for habitabilize zone and flux for each exoplanet
hzFluxData <- hzFluxCalculator(planetData)

# List habitable planets using "optimistic" parameters from
# Planetary Habitability Laboratory
listHabitablePlanets <- habitableExoFinder(hzFluxData, minTemp = 181, maxTemp = 279,
                                           maxEarthMass = 10, maxEarthRadius = 2.5)
head(listHabitablePlanets)
```


```{r , echo=TRUE, eval=TRUE}
# New vector with temporary data
tempMassData <- annualExoDiscoveries() 

# Scatter plot of masses/radii for discovered exoplanets
# Use LaTeX to denote the standard astronomical symbol for the Earth
tempMassScatter <- ggplot(tempMassData, aes(x = log10(pl_bmasse), y = pl_rade))
tempMassScatter + geom_point(aes(col = pl_eqt, size = pl_bmasse), alpha = 0.6, position = "jitter") +
  scale_color_gradientn(colours = heat.colors(5)) +
  labs(x = TeX(r'(Mass $(log(M\oplus))]$))'), y = TeX(r'(Radius $(R\oplus)$)'),
       title = "Comparison of radius and logarithmic mass amongst known exoplanets", col = "Equilbrium temperature (K)",
       size = TeX(r'(Planet Mass $(M\oplus)$)'))
```

```{r , echo=TRUE, eval=TRUE}
planetClusters <- annualExoDiscoveries()
planetClusters <- planetClusters %>% select(pl_bmasse, pl_bmassj) %>% filter()
```


```{r , echo=TRUE, eval=TRUE}
metallicityData <- annualExoDiscoveries() 
metallicityData <- metallicityData %>% select(st_metratio, st_met, pl_bmassj, pl_bmasse, pl_orbper) %>% 
  filter(st_metratio == "[Fe/H]" & !(is.na(pl_bmassj)) & (pl_bmassj >= 0.6))

metallicityData %>% mutate(category = NA)

for(i in 1:length(metallicityData$pl_bmassj)){
  
  if(metallicityData$pl_bmassj[i] <= 0.9 & metallicityData$pl_bmassj[i] >= 0.6){
    metallicityData$category[i] <- "Sub-Jupiter"
  } else if(metallicityData$pl_bmassj[i] <= 4) {
    metallicityData$category[i] <- "Jupiter-mass"
  } else {
    metallicityData$category[i] <- "Super-massive"
  }
}

metallicityHisto <- ggplot(metallicityData, aes(x = st_met))
metallicityHisto + geom_histogram(aes(fill = category)) +
  labs(x = "Stellar Effective Temperature [K]", y = "Count",
       title = "The distribution of planets as a function of stellar effective temperature") 
```

```{r , echo=TRUE, eval=TRUE}
orbPerEccen <- annualExoDiscoveries() 

exoDiscoveryScatter <- ggplot(orbPerEccen, aes(x = log(pl_orbper), y = pl_orbeccen))
exoDiscoveryScatter + geom_point(aes(size = pl_bmassj, color = pl_bmassj), alpha = 0.6, position = "jitter")
```

## References


